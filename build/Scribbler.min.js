/*! Scribbler 2013-05-17 */
function rgb2hsl(a,e,t){a/=255,e/=255,t/=255;var r,o,i,n=Math.min(a,e,t),s=Math.max(a,e,t),l=s-n;return s===n?r=0:a===s?r=(e-t)/l:e===s?r=2+(t-a)/l:t===s&&(r=4+(a-e)/l),r=Math.min(60*r,360),0>r&&(r+=360),i=(n+s)/2,o=s===n?0:.5>=i?l/(s+n):l/(2-s-n),[r,100*o,100*i]}var createBgPaintArray=function(){return pixelDataArray(0)},background=function(){flipCanvas(),lastMode="bgimg",lastBgArray=bgPaintArray;for(var a,e,t,r,o,i,n,s,l=x.getImageData(0,0,w,h),c=l.data.length/4,g=0;c>g;g++){a=4*g,e=l.data[a],t=l.data[a+1],r=l.data[a+2],o=rgb2hsl(e,t,r),i=o[0],n=o[1],s=o[2];var d=Math.floor(g/w),u=g%w;isGreen(i,n,s)&&(bgPaintArray[d][u]=colorValue),0===bgPaintArray[d][u]?l.data[a+3]=0:(l.data[a]=bgPaintArray[d][u][0],l.data[a+1]=bgPaintArray[d][u][1],l.data[a+2]=bgPaintArray[d][u][2])}x.putImageData(l,0,0),!erasing&&painting&&setTimeout(background,.024)},createMaskArray=function(){return pixelDataArray(255)},erase=function(){flipCanvas();var a=x.getImageData(0,0,w,h),e=a.data.length/4;pixelDataArray(void 0);for(var t,r,o,i,n,s,l,c,g=0;e>g;g++){t=4*g,r=a.data[t],o=a.data[t+1],i=a.data[t+2],n=rgb2hsl(r,o,i),s=n[0],l=n[1],c=n[2];var d=Math.floor(g/w),u=g%w;isGreen(s,l,c)&&(maskArray[d][u]=0),a.data[4*g+3]=maskArray[d][u]}x.putImageData(a,0,0),setTimeout(erase,50)},eraser=function(){flipCanvas();var a=x.getImageData(0,0,w,h),e=a.data.length/4;pixelDataArray(void 0);for(var t=0;e>t;t++){index=4*t,r=a.data[index],g=a.data[index+1],b=a.data[index+2],hsl=rgb2hsl(r,g,b),ha=hsl[0],s=hsl[1],l=hsl[2];var o=Math.floor(t/w),i=t%w;isGreen(ha,s,l)&&(paintArray[o][i]=!1),paintArray[o][i]&&(a.data[4*t]=paintArray[o][i][0],a.data[4*t+1]=paintArray[o][i][1],a.data[4*t+2]=paintArray[o][i][2])}x.putImageData(a,0,0),erasing&&!painting&&setTimeout(eraser,50)},flipCanvas=function(){x.save(),x.translate(w,0),x.scale(-1,1),x.drawImage(v,0,0,w,h),x.restore()},pixelDataArray=function(a){for(var e,t=[],r=0;h>r;r++){e=[];for(var o=0;w>o;o++)e.push(a);t.push(e)}return t},colorChooser=function(){switch(colorChoice){case"red":colorValue=[255,0,0,255];break;case"orange":colorValue=[255,165,0,255];break;case"yellow":colorValue=[255,255,0,255];break;case"green":colorValue=[0,255,0,255];break;case"blue":colorValue=[30,144,255,255];break;case"purple":colorValue=[128,0,128,255];break;case"black":colorValue=[0,0,0,255];break;case"white":colorValue=[255,255,255,255]}},isGreen=function(a,e,t){return a>=75&&165>=a&&e>=25&&90>=e&&t>=20&&95>=t},toggleArrow=function(){$(".arrow").fadeToggle("slow",toggleArrow)},c2=document.querySelector("#main-canvas2"),x2=c2.getContext("2d"),pictureLayerArray=function(){imgLoaded=!1,img=document.createElement("img"),x.drawImage(v,0,0,w,h);var a=function(){imgLoaded=!0,x2.drawImage(img,0,0,640,480),magiceraser()};img.src="src/rg.jpg",img.onload=a},magiceraser=function(){x.drawImage(v,0,0,w,h);var a=x.getImageData(0,0,w,h),e=a.data.length/4,t=x2.getImageData(0,0,w,h);t.data.length/4,magicEraserArray=pixelDataArray(void 0);for(var r,o=0,i=0;h>i;i++)for(var n=0;w>n;n++){r=[];for(var s=0;4>s;s++)r.push(t.data[o]),o++;magicEraserArray[i][n]=r}for(var l,c,g,d,u,p,m,f,o=0;e>o;o++){l=4*o,c=a.data[l],g=a.data[l+1],d=a.data[l+2],u=rgb2hsl(c,g,d),p=u[0],m=u[1],f=u[2];var i=Math.floor(o/w),n=o%w;p>=70&&180>=p&&m>=25&&90>=m&&f>=20&&95>=f&&(magicEraserArray[i][n]=0,t.data[4*o+3]=magicEraserArray[i][n])}x.putImageData(a,0,0),x2.putImageData(t,0,0),setTimeout(magiceraser,50)},v=document.querySelector("#main-video"),c=document.querySelector("#main-canvas"),image=document.querySelector("#main-image"),x=c.getContext("2d"),hl=document.querySelector("#highlight"),localStream,h=570,w=760,erasing,painting,colorChoice,colorValue,paintArray,bgPaintArray,elementAttr,pencilClass,currentText,wordArray,allowed,displayElement,lastBgArray,lastMode="video",videoRunning=!1,mode;$(document).ready(function(){$(".modal").modal({show:!0}),$(".carousel").carousel("pause"),$(".carousel").on("slid","",function(){$(".carousel-inner .item:last").hasClass("active")&&($(".next").hide(),$(".skip").text("START").addClass("btn-large").addClass("btn-success"))}),allowed="no"}),$("#main-video").attr("width",w+"px").attr("height",h+"px"),$("#main-canvas").attr("width",w+"px").attr("height",h+"px"),$("#main-image").attr("width",w+"px").attr("height",h+"px");var hasGetUserMedia=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)};hasGetUserMedia()?(window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,$("#start-button").on("click",function(){switch(videoRunning||(recordVideo(),$("#textarea").text("Press the allow button up top to start!"),$("#start-button p").html('<i class="icon-refresh"></i>Clear')),lastMode){case"video":paintArray=pixelDataArray(void 0);break;case"bgimg":bgPaintArray=lastBgArray;break;default:console.log("ignored!")}}),$(".skip").on("click",function(){$(".modal").modal("hide"),recordVideo(),$('<img class="svg arrow" src="./img/arrow.svg" />').appendTo("body").fadeIn("slow",toggleArrow)}),$("#eraser-button").on("click",function(){void 0===paintArray?$("#textarea").text("Please click start to begin painting"):(painting=!1,erasing=!0,eraser())}),$("#picture-button").on("click",function(){mode="background",snapShot()}),$("#paint-button").on("click",function(){$("video").attr("src")?(colorChoice?"black"===colorChoice&&$("#textarea").text("Would you like to try more colors"):(colorChoice="black",colorValue=[0,0,0,255],$("#textarea").text("You are painting with "+colorChoice).removeClass("brown-pencil").addClass(colorChoice+"-pencil")),$(".color-palette").fadeIn(400),$("#main-video").css("display","none"),$("#main-canvas").css("display","inline-block"),void 0===paintArray&&(paintArray=createPaintArray()),painting=!0,erasing=!1,"canvas"===displayElement?(console.log("calling background..."),background()):paint()):$("#textarea").text("Please click start to begin painting")}),$("#speech-button").on("click",function(){"no"===allowed&&$('<img class="svg arrow" src="./img/arrow.svg" />').appendTo("body").fadeIn("slow",toggleArrow),$("video").attr("src")?($("video").hide(),$("canvas").show(),$(".color-palette").fadeIn(400),console.log("recording..."),toggleStartStop(),$("#textarea").bind("newWord",function(a){console.log(a),currentText=$(this).text(),wordArray=currentText.split(" "),elementAttr=$("#textarea").attr("class").split(" "),pencilClass=elementAttr[elementAttr.length-1],colorChoice=wordArray[wordArray.length-1],$("#textarea").text("You are painting with "+colorChoice).removeClass(pencilClass).addClass(colorChoice+"-pencil"),$(".pencil-tip").css("border-bottom","12px solid "+colorChoice),$("#main-video").css("display","none"),void 0===paintArray&&(paintArray=createPaintArray()),painting=!0,erasing=!1,console.log(mode),colorChooser(),"background"===mode?background():paint()})):$("#textarea").text("Please click start to begin painting")}),$("li").on("click",function(){colorChoice=$(this).attr("class"),elementAttr=$("#textarea").attr("class").split(" "),pencilClass=elementAttr[elementAttr.length-1],colorChooser(),$("#textarea").text("You are painting with "+colorChoice).removeClass(pencilClass).addClass(colorChoice+"-pencil"),$(".pencil-tip").css("border-bottom","12px solid "+colorChoice)}),$("#save-button").on("click",function(){console.log("stopping.."),$(".color-palette").fadeOut(400),"background"!==mode&&($("#main-video").css("display","none"),$("#main-canvas").css("visibility","visible")),saveImage()}),$("#info-button").on("click",function(){$(".modal").modal()})):alert("please use a better browser");var createPaintArray=function(){return pixelDataArray(!1)},paint=function(){flipCanvas(),lastMode="video";var a=x.getImageData(0,0,w,h),e=a.data.length/4;pixelDataArray(void 0);for(var t,r,o,i,n,s,l,c,g=0;e>g;g++){t=4*g,r=a.data[t],o=a.data[t+1],i=a.data[t+2],n=rgb2hsl(r,o,i),s=n[0],l=n[1],c=n[2];var d=Math.floor(g/w),u=g%w;isGreen(s,l,c)&&(paintArray[d][u]=colorValue),paintArray[d][u]&&(a.data[t]=paintArray[d][u][0],a.data[t+1]=paintArray[d][u][1],a.data[t+2]=paintArray[d][u][2])}x.putImageData(a,0,0),!erasing&&painting&&setTimeout(paint,.024)},recordVideo=function(){navigator.getUserMedia({video:!0},function(a){localStream=a,v.src=window.URL.createObjectURL(localStream),$("video").attr("src")&&(displayElement="video",$(".arrow").remove())}),videoRunning=!0},saveImage=function(){$(".color-palette").fadeOut(400),painting||erasing||($(".main-video").hide(),flipCanvas(),$(".main-canvas").show()),dataURL=c.toDataURL(),image.src=dataURL,$(".main-canvas").hide(),$(".main-image").show(),$("#save-button a").attr("href",dataURL)},snapShot=function(){$(".color-palette").fadeOut(400),$(".main-video").hide(),flipCanvas(),$(".main-canvas").show(),dataURL=c.toDataURL(),$("#main-canvas").css("background-image","url("+dataURL+")"),$("#main-canvas").css("background-size","cover"),void 0===bgPaintArray&&(bgPaintArray=createBgPaintArray())};if("webkitSpeechRecognition"in window){var recognizing,output="",textarea=document.getElementById("textarea"),recognition=new webkitSpeechRecognition;recognition.continuous=!0,recognition.onstart=function(){allowed="yes",$(".arrow").remove(),console.log("recording..."),recognizing=!0},recognition.onresult=function(a){if(a.results===void 0)return console.log("event.results is undefined"),recognition.onend=null,recognition.stop(),void 0;console.log("testing event ",a.results);for(var e=a.resultIndex;a.results.length>e;++e)a.results[e].isFinal?(output=a.results[e][0].transcript,checkOutput(output)):alert("what happened..?")};var reset=function(){recognizing=!1,allowed="no",$("#speech-button p").text("Speak").parent().removeClass("orange").addClass("blue-purple")},toggleStartStop=function(){recognizing?(console.log("stop recording..."),reset()):(recognition.start(),recognizing=!0,console.log("in the else",recognition),$("#speech-button p").html('<i class="icon-microphone-off"></i>Stop'))},checkOutput=function(a){a.length>0?(console.log("checking output..."),lastWord(a)):alert("Oops, please speak into the microphone.")},lastWord=function(a){words=a.split(" ");var e=words.pop();"red"===e||"blue"===e||"green"===e||"orange"===e||"yellow"===e||"purple"===e?(console.log("the string...",a),textarea.innerHTML="You are painting with "+a,$("#textarea").trigger("newWord")):console.log("Oops, you said "+e+" please say a color instead.")}}else alert("Oh no your browser is too old for this!");var scoreSum=function(a,e){for(var t=10,r=t;h-t>r;r++)for(var o=t;w-t>o;o++){a[r][o]=e[r][o];for(var i=t-1;i>0;i--)a[r][o]+=e[r-i][o]+e[r+i][o],a[r][o]+=e[r][o-i]+e[r][o+i]}},findClosestHighScore=function(a){targetx=0,targety=0,targetscore=0;for(var e=10;h-10>e;e++)for(var t=10;w-10>t;t++)a[e][t]>targetscore&&(targetx=e,targety=t,targetscore=a[e][t])},highlightPlacer=function(a,e){hl.style.left=""+targetx+"px",hl.style.top=""+(2*$(".button-toolbar").height()+targety)+"px",a.putImageData(e,0,0)},pixels,pixCount,draw=function(){x.save(),x.translate(w,0),x.scale(-1,1),x.drawImage(v,0,0,w,h),x.restore(),pixels=x.getImageData(0,0,w,h),pixCount=pixels.data.length/4;for(var a,e,t,r,o,i,n,s,l=pixelDataArray(0),c=l,g=l,d=0;pixCount>d;d++){a=4*d,e=pixels.data[a],t=pixels.data[a+1],r=pixels.data[a+2],o=rgb2hsl(e,t,r),i=o[0],n=o[1],s=o[2];var u=Math.floor(d/w),p=d%w;i>=70&&180>=i&&n>=25&&90>=n&&s>=20&&95>=s?(pixels.data[4*d+3]=0,c[u][p]=1):c[u][p]=0}scoreSum(g,c),findClosestHighScore(g),highlightPlacer(x,pixels),setTimeout(draw,50)};